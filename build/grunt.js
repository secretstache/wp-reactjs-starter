var SERVE_DIR,
    _ = require("lodash"),
    exec = require("child_process").exec;

module.exports = function(grunt) {
    grunt.loadNpmTasks("grunt-cachebuster");
    grunt.loadNpmTasks("grunt-node-modules-cachebuster");
    grunt.loadNpmTasks("grunt-contrib-copy");
    grunt.loadNpmTasks("grunt-contrib-clean");
    grunt.loadNpmTasks("grunt-contrib-compress");
    grunt.file.defaultEncoding = "utf8";

    // Detect SERVE_DIR
    SERVE_DIR = _.trimEnd(grunt.config.get("SERVE_DIR") || "dist", "/");
    if ([".", "./", "/"].indexOf(SERVE_DIR) > -1) {
        throw new Error("SERVE_DIR is not valid.");
    }

    /**
     * Tasks configuration.
     */
    grunt.config.merge({
        clean: {
            serve: SERVE_DIR + "/**/*",
            serveAfter: [SERVE_DIR + "/public/src", SERVE_DIR + "/composer.*"]
        },
        copy: {
            serve: {
                expand: true,
                src: [
                    "composer.json",
                    "index.php",
                    "inc/**/*",
                    "public/**/*",
                    "LICENSE",
                    "CHANGELOG.md",
                    // "README.md", The original readme is excluded because it is for GIT only
                    "README.wporg.txt",
                    "languages/**/*"
                ],
                dest: SERVE_DIR
            }
        },
        compress: {
            serve: {
                options: {
                    archive: "dist/<%= pkg.name %>-<%= pkg.version %>-plugin.zip"
                },
                expand: true,
                cwd: "dist",
                src: "<%= pkg.name %>/**/*"
            }
        },
        cachebuster: {
            public: {
                options: {
                    banner:
                        "/* This file was automatically generated by the `grunt public-cachebuster` command (" +
                        new Date().toString() +
                        "). */",
                    format: "php"
                },
                src: (function() {
                    var src = [];
                    ["dist", "dev"].forEach(function(folder) {
                        src = src.concat(["public/" + folder + "/**/*.js", "public/" + folder + "/**/*.css"]);
                    });
                    return src;
                })(),
                dest: "inc/others/cachebuster.php"
            }
        },
        node_modules_cachebuster: {
            publiclib: {
                options: {
                    banner:
                        "/* This file was automatically generated by the `grunt public-cachebuster` command (" +
                        new Date().toString() +
                        "). */",
                    format: "php"
                },
                src: ["public/lib/*"],
                dest: "inc/others/cachebuster-lib.php"
            }
        }
    });

    /**
     * Cachebuster task
     */
    grunt.registerTask("public-cachebuster", ["cachebuster:public", "node_modules_cachebuster:publiclib"]);

    /**
     * Copy npm libraries task.
     */
    grunt.registerTask("copy-npmLibs", ["clean:npmLibs", "copy:npmLibs", "node_modules_cachebuster:publiclib"]);

    /**
     * Serve task.
     */
    grunt.registerTask("serveDo", function() {
        var done = this.async();
        grunt.log.writeln("Install no-dev composer dependencies... (SERVE_DIR=" + SERVE_DIR + ")");
        exec("composer install --no-dev --no-scripts --prefer-dist --working-dir " + SERVE_DIR, function(
            error,
            stdout,
            stderr
        ) {
            console.log(stdout);
            done();
        });
    });
    grunt.registerTask(
        "serve",
        ["clean:serve", "copy:serve", "serveDo", "clean:serveAfter"].concat(grunt.config.get("SERVE_POST_TASKS") || [])
    );

    /**
     * Versioning task.
     */
    grunt.registerTask("postversion", function() {
        var version = grunt.config.get("pkg.version"),
            indexphp = grunt.file.read("index.php"),
            newindexphp = indexphp.replace(/Version:(\s*)(.*)$/gm, "Version:$1" + version);
        grunt.file.write("index.php", newindexphp);
    });

    /**
     * Serve README.txt generator
     *
     * @legacy
     */
    grunt.registerTask("serveReadmeTxt", function() {
        let publicTxt = grunt.file.read(SERVE_DIR + "/README.wporg.txt");
        publicTxt = publicTxt.replace(/\[include:([^\]]+)\]/g, (matched, index) =>
            grunt.file.exists(SERVE_DIR + "/" + index) ? grunt.file.read(SERVE_DIR + "/" + index) : matched
        );
        grunt.file.write(SERVE_DIR + "/README.txt", publicTxt);
        grunt.file.delete(SERVE_DIR + "/README.wporg.txt");
    });

    /**
     * Serve rename readme task
     *
     * @legacy
     */
    grunt.registerTask("serveRenameReadme", function() {
        grunt.file.copy(SERVE_DIR + "/README.md", SERVE_DIR + "/README.txt");
        grunt.file.delete(SERVE_DIR + "/README.md");
    });
};
